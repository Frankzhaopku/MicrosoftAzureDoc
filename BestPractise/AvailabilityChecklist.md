#可用性清单
===

## 应用设计
---
* **避免所有的[单点故障](https://en.wikipedia.org/wiki/Single_point_of_failure)**：所有的组件、服务、资源和计算实例都应该以多例方式部署，以避免因单点故障导致而导致可用性受到影响。这也包括了用户登录机制。将应用设计为可配置多例部署、自动检测实例故障并将请求重定向到非故障实例上，一般平台都不会自动实现这个机制。

* **为每一个[SLA](https://en.wikipedia.org/wiki/End-user_license_agreement)分解工作**：若一个服务有关键工作和非关键工作组成，应该分别管理这些工作，并根据服务的特点来配置不同数量的实例使得其可以达到可用性指标要求。

* **最小化并了解服务依赖**：尽可能减少使用的服务，并确保你完全了解系统中使用的服务的特性与依赖关系。包括这些依赖的特点以及每一个依赖的故障或性能损失对整个应用的影响。Microsoft对于大多数服务都保证了至少99.9%的可用性，但是这表示你的应用每多使用一个依赖服务会导致系统在可用性上有0.1%故障的可能性积累。

* **将任务和消息设计为[幂等](https://en.wikipedia.org/wiki/Idempotence)的**：这样的话重复请求并不会导致问题。例如，一个服务作为消费者角色处理由其他作为生产者角色发出的请求消息。当消费者服务在处理消息但没来得及确认返回时发生了故障，那么生产者很可能会再次发送请求，该请求将可能被另一个消费者服务接到。因此消费者服务应该对于重复操作有幂等性，这样不会因为重复执行之前的操作而导致非法结果。这意味着使用重复消息检测或使用乐观控制保证一致性的方法来解决冲突。

* **为关键事务使用具有高可用性的消息代理**：很多场景下，我们都是用消息传递指令以发起任务或进行远程调用。为了较好的性能表现，应用应该发送消息后立即返回，而不用等待收到回复。消息系统应该具有极高的可用性以保证消息可以被送达。服务总线消息队列（Service Bus Message Queues）应该实现*至少一次*语义，虽然有时候可能会接收到重复的消息，但是一个进入消息队列的消息不应该丢失。如果消息处理是幂等的（见上条），则消息的重复送达并不会导致错误。

* **将应用设计为可以优雅降级的**：当资源使用到达极限时，应该在尽量减少对用户影响的情况下采用适当的措施。有些情况下，应用的负载会超过一个或多个部分的承受能力，导致可用性的降低和连接失败。水平扩展可以缓解这个问题，但依然可能因资源或成本因素而到达极限。应该将应用设计为在这种情况下可以自动优雅降级。例如，一个电商系统中，订单处理系统处于过压状态（甚至已经完全故障失效），应该可以在允许其他部分（如查看商品目录等）正常运作的情况下暂时停止这个子系统。延迟发往一个失效子系统的请求时比较合适的做法，例如在订单子系统恢复前依然允许用户提交订单，但只是将订单存入一个队列或其他的安全存储机制中。

* **优雅处理迅速爆发性事件**：大多数应用都需要根据时间的不同来处理不同的工作负载，如商务系统中早上会遇到一个高峰或电商网站发布新的产品时等。自动伸缩（auto-scaling）有助于处理此类问题，但新的实例上线并处理请求时需要一定时间的。为了防止突发的意外爆发性活动导致应用故障，应该将其设计为将服务请求放入消息队列中，并在队列容量将满时进行优雅降级处理。仅需确保在正常情况下有足够的性能和容量处理消息队列中的所有未处理消息即可。有关的详细信息，请参见[基于队列的负载调配操作模式]()

##部署与维护
---
* **为每个服务部署多个实例**：Microsoft对用户创建部署的服务可用性做出一定的保证，但这些保证只有在为每个服务部署了至少两个实例的时候才是有效的。这样可以使一个实例出现故障时让另一个实例提供服务。在对线上系统进行升级而不想对客户有任何影响时，这样的部署方式是极为重要的，这样的话可以在某一实例提供服务时单独关闭并升级另一实例。

* **服务器应用应该在多个不同的数据中心**：即便可能性极小，但整个数据中心依然有可能因为自然灾害或大规模Internet故障而全体停机。核心的重要业务应该被部署在多个不同的数据中心中以保证可用性的最大化。这样做另外的好处是减少本地用户的网络延迟，并为升级应用提供了更多的灵活性。

* **测试并自动化部署与维护任务**：分布式应用需要由多个必须同时运作的组件组成，因此应该使用经过测试的部署机制，例如脚本或用于升级验证配置的部署应用来自动化部署的过程。自动化技术也应该用在一些应用内的组件升级过程上。当然，全面测试部署过程以保证过程中的错误不会导致服务失效是至关重要的。所有的部署工具都应该有相应的安全限制来保护已经部署的应用，应该仔细定义并执行部署策略，以减少人工干预的必要性。

* **考虑使用平台提供的开发与生产环境相关特性**：例如，在使用Azure云服务时，应用的开发环境和生产环境的可以通过切换虚拟IP地址（[VIP swap]()）进行切换。但如果你希望开发与生产环境同时上线并逐渐做用户迁移，那么可能并不适合这个服务。

* 尽可能**在不重启服务的情况下应用新的配置**：在很多情况下，Azure应用或服务都可以在不重启实例的情况下修改配置。实例会注册监听配置更改的事件，并在配置发生改变时将这些改变自动应用到组件中去，但确实有一些涉及核心平台的配置会要求服务必须重启。在构建组件和服务时，应该通过使组件无需要求整个系统来重启即可改变配置来做到可用性最大化与停机时间最小化。

* **使用升级域（Upgrade domain）做到零停机升级**：Azure的计算单元，如web和worker都安置在升级域中。升级域会将所有的实例集中起来，当升级开始时，每一个实例会依次停机、升级、重启，这样便最小化了应用升级对用户造成的影响。在服务部署时你可以指定为服务创建多少个升级域。（注：实例同样会分布在不同的故障域（Fault domain）中，这些域的服务器、电力、冷却系统都是完全独立的，这样可以最小化因为基础设施故障导致的实例停机。这样的分布是自动且用户不可控的。）

* **为Azure的虚拟机配置可用集（Availability sets）**：将两个或以上的虚拟机放入同一个可用集中可以保证这些虚拟机不会被部署到同一个故障域中。为了最大化可用性，应该为每一个关键虚拟机启动多个实例，并将其放入同一可用集中。如果你在使用多个虚拟机进行不同的服务，为每一个虚拟机建立一个可用集并将不同虚拟机的实例放入相应的可用集中。例如，当你使用不同的虚拟机作为Web服务器和报表服务器时，你应当分别为它们建立不同的可用集并将Web服务器虚拟机放入Web服务器可用集，将报表服务器虚拟机实例放入报表服务器可用集。




